services:
  # Локальный Telegram Bot API (не публикуем наружу)
  tg-bot-api:
    image: aiogram/telegram-bot-api:latest
    container_name: tg-bot-api
    user: "0:0"
    restart: unless-stopped
    networks: [app-net]
    ports:
      - "127.0.0.1:8081:8081"
    env_file:
      - .env
    environment:
      TELEGRAM_API_ID: "${TELEGRAM_API_ID}"
      TELEGRAM_API_HASH: "${TELEGRAM_API_HASH}"
      TELEGRAM_BOT_TOKEN: "${TELEGRAM_BOT_TOKEN}"
      TELEGRAM_LOCAL: "1"
    command: >
      --api-id=${TELEGRAM_API_ID}
      --api-hash=${TELEGRAM_API_HASH}
      --dir=/var/lib/telegram-bot-api
      --http-port=8081
      --local
    volumes:
      - /opt/tg-bot-api:/var/lib/telegram-bot-api
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8081/bot$TELEGRAM_BOT_TOKEN/getMe | grep -q '\"ok\":true'"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s
  n8n:
    image: n8n-ffmpeg
    container_name: n8n
    restart: unless-stopped
    networks: [app-net]
    depends_on:
      tg-bot-api:
        condition: service_healthy
    ports:
      - "5678:5678"
    env_file:
      - .env
    environment:
      # Database Configuration
      - N8N_HOST=mqrkin.fvds.ru
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://mqrkin.fvds.ru/

      # Editor URL for webhook generation
      - N8N_EDITOR_BASE_URL=https://mqrkin.fvds.ru/

      # Execution settings

      # Security
      - N8N_SECURE_COOKIE=false      
      # Timezone
      - GENERIC_TIMEZONE=Europe/Moscow
      - TZ=Europe/Moscow

      # File paths for Telegram bot cache
      - TG_CACHE_PATH=/opt/tg-bot-api

      # Telegram Bot Configuration
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_API_BASE=http://tg-bot-api:8081

      # DigitalOcean Spaces / S3 Configuration
      - DO_SPACES_KEY=${DO_SPACES_KEY}
      - DO_SPACES_SECRET=${DO_SPACES_SECRET}
      - DO_SPACES_BUCKET=${DO_SPACES_BUCKET}
      - DO_SPACES_ENDPOINT=${DO_SPACES_ENDPOINT}
      - DO_SPACES_REGION=${DO_SPACES_REGION:-nyc3}
      - DO_CDN_DOMAIN=${DO_CDN_DOMAIN:-}

      # Replicate API Configuration
      - REPLICATE_API_TOKEN=${REPLICATE_API_TOKEN}


    volumes:
      - n8n_data:/home/node/.n8n
      - /tmp:/tmp
      - /opt/tg-bot-api:/opt/tg-bot-api

volumes:
  n8n_data:
    driver: local

networks:
  app-net:
    driver: bridge
